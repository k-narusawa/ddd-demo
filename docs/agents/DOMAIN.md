# ドメイン層の実装方針

ドメイン層はビジネスの核となるルールとロジックを配置する、このアプリケーションで最も重要な層です。フレームワークやUIなど、他のどのレイヤーにも依存しません。

## エンティティ (Entity)

一意な識別子を持ち、ライフサイクルを通じて状態が変化するオブジェクトです。

- **アノテーション**: `jakarta.persistence.Entity` の `@Entity` を付与します。
- **識別子**:
    - 識別子は専用の値オブジェクトとして定義し、`@EmbeddedId` を付与します。
    - これにより、プリミティブ型ではなく、ドメインの概念としてIDを扱うことができます。
- **同一性**:
    - 識別子が同一であれば、他のプロパティが異なっていても同じエンティティと見なします。
    - そのため、`equals()` と `hashCode()` を識別子に基づいてオーバーライドすることが必須です。
- **実装例**: `dev.k_narusawa.ddd_demo.app.identity_access.domain.user.User`

## 値オブジェクト (Value Object)

属性そのものでオブジェクトを識別する、不変 (Immutable) なオブジェクトです。

- **アノテーション**: 永続化の対象とする場合は `jakarta.persistence.Embeddable` の `@Embeddable`
  を付与します。
- **クラス定義**:
    - `data class` を利用して、`equals`, `hashCode`, `toString` などの基本的なメソッドを自動生成します。
- **不変性の保証**:
    - コンストラクタは `private` とし、インスタンス生成はファクトリメソッド（例: `of()`）を通じて行います。
    - プロパティは `val` で宣言し、外部から変更できないようにします。
- **バリデーション**:
    - `init` ブロック内で `require` を使用し、不正な値でインスタンスが生成されることを防ぎます。
- **プロパティ**:
    - 原則として `value` という名前の単一のプロパティを持ちます。
    - カプセル化のため、この `value` プロパティは `private` とし、専用の `get()`
      メソッドを介してのみアクセスできるようにします。
- **実装例**: `dev.k_narusawa.ddd_demo.app.identity_access.domain.user.Username`

## 集約 (Aggregate)

関連するエンティティと値オブジェクトをまとめ、一貫性を保つための境界です。

- **集約ルート**:
    - 集約は、外部からその内部のオブジェクトに直接アクセスすることを禁止します。
    - 必ず「集約ルート」と呼ばれる単一のエンティティを通じてのみ、集約内の操作を行います。
- **責務**:
    - 集約は、その境界内でビジネスルールの一貫性を維持する責任を持ちます。トランザクションは、原則として1つの集約に対して行います。
- **実装例**: `User` エンティティが集約ルートとして機能します。

## リポジトリ (Repository)

集約の永続化を抽象化し、ドメイン層とインフラストラクチャ層を分離するためのインターフェースです。

- **責務**:
    - 集約の取得（IDによる検索など）、保存（新規作成、更新）、削除といった責務を持ちます。
    - ドメイン層にはインターフェースのみを定義します。実際の永続化処理（JPAなど）はアダプター層（インフラストラクチャ層）で実装します。
- **命名規則**: `{集約名}Repository` という命名規則に従います。（例: `UserRepository`）
- **実装例**: `dev.k_narusawa.ddd_demo.app.identity_access.domain.user.UserRepository`

## ドメインサービス (Domain Service)

特定のエンティティや値オブジェクトに自然に属さない、ドメイン固有のロジックを配置します。

- **利用シーン**:
    - 複数の集約をまたがる操作。
    - ドメインオブジェクトの生成（例: パスワードのハッシュ化など）。
- **ステートレス**:
    - ドメインサービスは状態を持たない（ステートレスな）操作であるべきです。
- **実装例**: `dev.k_narusawa.ddd_demo.app.identity_access.domain.user.UserService`

## ドメインイベント (Domain Event)

ドメイン内で発生した、ビジネス上意味のある事象を表現するオブジェクトです。

- **目的**:
    - バウンデッドコンテキスト間の疎結合な連携を実現します。
    - ある集約で起きた変更を、他の集約やコンテキストに通知するために使用します。
- **命名規則**: 過去形で命名します。（例: `UserSignupCompletedEvent`）
- **実装**:
    - `DomainEvent` インターフェースを実装します。
    - イベントの発行は、集約ルートのメソッド内で行い、Spring Frameworkのイベント発行機能などを利用して通知します。
- **実装例**:
  `dev.k_narusawa.ddd_demo.app.identity_access.domain.user.event.UserSignupCompletedEvent`
